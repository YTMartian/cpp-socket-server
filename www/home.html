<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <meta name="baidu-site-verification" content="4j1Ctek6Sd" />
  <meta charset="UTF-8" http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Home</title>
  <script>
    var username = localStorage.getItem('username');
    if (username == 'failed' || username == null || username.length == 0) {
        window.location.href = '/login.html'
    }
  </script>
  <link rel="stylesheet" type="text/css" href="assets/css/nav.css" />
  <link rel="stylesheet" type="text/css" href="assets/fonts/iconfont.css" />
  <link rel="stylesheet" type="text/css" href="assets/css/style.css" />
  <link rel="stylesheet" type="text/css" href="assets/css/button.css" />
</head>
<body>
  <div class="nav" id="my-nav">
    <div style="position:sticky;top:0">
      <br />
      <br />
      <ul>
        <li class="nav-item">
          <a href="javascript:" id="show-nav"><i class="my-icon nav-icon icon_1"></i><span id="username"></span><i class="my-icon nav-more"></i></a>
          <ul>
            <li>
              <a href="javascript:" onclick="previous()"><span>ËøîÂõû‰∏ä‰∏ÄÁ∫ß</span></a>
            </li>
            <li>
              <a href="javascript:" onclick="upload()"><span>‰∏ä‰º†Êñá‰ª∂</span></a>
            </li>
            <li>
              <a href="javascript:" onclick="newfolder()"><span>Êñ∞Âª∫Êñá‰ª∂Â§π</span></a>
            </li>
            <li>
              <a href="javascript:" onclick="userLogout()"><span>ÈÄÄÂá∫ÁôªÂΩï</span></a>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
  <div id="my-table"></div>
  <div style="display:none">
    <input type="file" id="file-upload" />
  </div>
  <!-- <button style="position:fixed;top:23%;right:1%;"id="previous-dir" class="button button-caution button-pill button-small">ËøîÂõû‰∏ä‰∏ÄÁ∫ß</button>
<button style="position:fixed;top:23%;left:14%;"class="button button-pill button-small">‰∏ä‰º†</button> -->
  <script src="assets/js/jquery-1.11.0.min.js"></script> 
  <script type="text/javascript" src="assets/js/nav.js"></script> 
  <script>

    $('#username').html(localStorage.getItem('username'));
    localStorage.setItem('current_path', 'dir/' + localStorage.getItem('username') + '/');
    var table_header = '<table style="margin-top:10%;margin-left: 20%"><tbody id="my-table-body">\n' +
        '        <tr class="tr-style">\n' +
        '            <th>Êñá‰ª∂Âêç</th>\n' +
        '            <th>Â§ßÂ∞è</th>\n' +
        '            <th>‰øÆÊîπÊó•Êúü</th>\n' +
        '            <th></th>\n' +
        '            <th></th>\n' +
        '        </tr>';
    var index_upvote = {};
    var index_downvote = {};
    load_directory();

    function load_directory(){ 
        var request = $.ajax({
                url: 'getByUrl',
                type: 'POST',
                async: true,
                timeout: 10000,
                dataType:"text",
                data: { 
                    'start':'true',
                    'file_name':'none',
                    'path':localStorage.getItem('current_path'),
                    'file_data':'none'
                },
                error: function (xhr, state, error) {
                    alert(error)
                },
                complete: function (XMLHttpRequest, status) {
                    if (status == 'timeout') {
                        request.abort();
                        window.alert('timeout')
                    }
                },
                success: function (response) {
                    var data = table_header;
                    if(response.length == 0){ 
                        $('#my-table').html(data);
                        return;
                    }
                    response = response.slice(0, response.length - 1);
                    var files = response.split('?');
                    files = new Set(files);//remove duplicates.
                    var i = new Date().getTime();
                    for (var file of files) {
                        i += 1;
                        var infos = file.split(':');
                        var file_name = infos[0].slice(localStorage.getItem('current_path').length, infos[0].length);
                        var size = infos[2];
                        if(infos[1] == "1"){
                            file_name += '/';
                            size = '--';
                        }
                        var modify_time = infos[3];
                        var likes = infos[4];
                        var dislikes = infos[5];
                        data += '<tr class="tr-style" id="row' + i + '">';
                        data += '<td><a onClick="fileclick(' + i + ')" href="javascripte:" id="filename'+i+'">' + file_name + '</a></td>';
                        data += '<td>' + size + '</td>';
                        data += '<td>' + modify_time + '</td>';
                        data += '<td><button class="button button-small button-glow button-circle button-action button-jumbo" onClick="upvote(' + i.toString()+ ')">üëç</button>&nbsp<span id="upvote' + i.toString() + '"' + '>'+ likes +'</span>&nbsp'
                        + '<button class="button button-small button-glow button-circle button-royal" onClick="downvote('+ i.toString()+')">üëé</button>&nbsp<span id="downvote' + i.toString() + '"' + '>'+ dislikes +'</span></td>'
                        data += '<td><button class="button button-small button-box button-jumbo" onClick="deletefile(' + i + ')">‚ùå</butotn></td>';
                        data += '</tr>';
                        index_upvote[i.toString()] = true;
                        index_downvote[i.toString()] = true;
                    }
                    data += '</tbody></table>';
                    $('#my-table').html(data);
                    $('#my-nav').height($(document).height());
                }
            }); 
    }
    
    function previous() {
        var current_path = localStorage.getItem('current_path');
        var items = current_path.split('/');
        var current_path = '';
        if(items.length <= 3)return;
        for(var i = 0; i < items.length - 2; i++){ 
            current_path += items[i] + '/';
        }
        localStorage.setItem('current_path', current_path);
        load_directory();
    }

    function upvote(id){ 
        var upvote = $.ajax({
	    url: 'upvote',
	    type: 'POST',
	    async: true,
	    data: {
		'filename': localStorage.getItem('current_path')+$("#"+"upvote" + id.toString()).parent().prevAll().eq(2).text(),
		'index_upvote': index_upvote[id]
	    },
	    timeout: 10000,
	    error: function () {
                alert('error')
            },
            complete: function (XMLHttpRequest, status) {
                if (status == 'timeout') {
                    request.abort();
                    window.alert('timeout')
                }
            },
	    success: function(response){
		if(index_upvote[id]==true){
		    $("#"+"upvote" + id.toString()).html(Number($("#"+"upvote" + id.toString()).html()) + 1);
		    index_upvote[id] = false;
		}else if(index_upvote[id]==false&&Number($("#"+"upvote" + id.toString()).html())>0){
		    $("#"+"upvote" + id.toString()).html(Number($("#"+"upvote" + id.toString()).html()) - 1);	
		    index_upvote[id] = true;	
		}
	        
	    }
	
	})
    }

    function downvote(id){ 
        var downvote = $.ajax({
	    url: 'downvote',
	    type: 'POST',
	    async: true,
	    data: {
		'filename': localStorage.getItem('current_path')+$("#"+"downvote" + id.toString()).parent().prevAll().eq(2).text(),
		'index_downvote': index_downvote[id]
	    },
	    timeout: 10000,
	    error: function () {
                alert('error')
            },
            complete: function (XMLHttpRequest, status) {
                if (status == 'timeout') {
                    request.abort();
                    window.alert('timeout')
                }
            },
	    success: function(response){
		if(index_downvote[id]==true){
		    $("#"+"downvote" + id.toString()).html(Number($("#"+"downvote" + id.toString()).html()) + 1);
		    index_downvote[id] = false;
		}else if(index_downvote[id]==false&&Number($("#"+"upvote" + id.toString()).html())>0){
		    $("#"+"downvote" + id.toString()).html(Number($("#"+"downvote" + id.toString()).html()) - 1);	
		    index_downvote[id] = true;	
		}
	    } 	
	})
    }

    function fileclick(id) {
        var file_name = $('#filename'+id).text();
        if(file_name.slice(-1) == '/'){ 
            var current_path = localStorage.getItem('current_path') + file_name;
            localStorage.setItem('current_path', current_path);
            load_directory();
        }
        else {
            var current_file = localStorage.getItem('current_path') + file_name;
            var pom = document.createElement("a");
            pom.setAttribute("href", current_file);
            pom.setAttribute("download", file_name);
            if (document.createEvent) {
                var event = document.createEvent("MouseEvents");
                event.initEvent("click", true, true);
                pom.dispatchEvent(event);
            } else {
                pom.click();
            }
        }
    }

    document.querySelector('#file-upload').addEventListener('change', event => {
        handle_upload(event)
    })

    function upload() {
        $('#file-upload').click()
    }

    const handle_upload = event => {
        var files = event.target.files;
        var form_data = new FormData();
        var filereader = new FileReader();
        filereader.readAsBinaryString(files[0], 'utf-8');
        filereader.onload=function(){ 
            file_data = this.result;
            var request = $.ajax({
                url: 'upload',
                type: 'POST',
                async: true,
                timeout: 10000,
                dataType:"text",
                data: { 
                    'start':'true',
                    'file_name':files[0].name,
                    'path':localStorage.getItem('current_path'),
                    'file_data':file_data
                },
                error: function (xhr, state, error) {
                    alert(error)
                },
                complete: function (XMLHttpRequest, status) {
                    if (status == 'timeout') {
                        request.abort();
                        window.alert('timeout')
                    }
                },
                success: function (response) {
                    if(response == "success"){
                        var today = new Date();
                        var current_time = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate() +' '+today.getHours() + ':' + today.getMinutes() + ":" + today.getSeconds();
                        var i = new Date().getTime();
                        var data = $('#my-table-body').html();
                        var size = '';
                        if(files[0].size < 1024) size = files[0].size + 'B';
                        else if(files[0].size < 1024*1024)size = (files[0].size / 1024).toFixed(2) + 'KB';
                        data += '<tr class="tr-style" id="row' + i + '">';
                        data += '<td><a onClick="fileclick(' + i + ')" href="javascript:" id="filename'+i+'">' + files[0].name + '</a></td>';
                        data += '<td>' + size + '</td>';
                        data += '<td>' + current_time + '</td>';
                        data += '<td><button class="button button-small button-glow button-circle button-action button-jumbo" onClick="upvote(' + i + ')">üëç</button>&nbsp<span>0</span>&nbsp'
                            + '<button class="button button-small button-glow button-circle button-royal" onClick="downvote(' + i + ')">üëé</button>&nbsp<span>0</span></td>';
                        data += '<td><button class="button button-small button-box button-jumbo" onClick="deletefile(' + i + ')">‚ùå</butotn></td>';
                        data += '</tr>';
                        $('#my-table-body').html(data);
                        $('#my-nav').height($(document).height());
                    }
                    alert(response);
                }
            });
        }      
    }

    function deletefile(id) {
        var flag = confirm('ÊòØÂê¶Âà†Èô§' + $('#filename'+id.toString()).text());
        if (flag) {
            var request = $.ajax({
                url: 'delete',
                type: 'POST',
                async: true,
                timeout: 10000,
                dataType:"text",
                data: { 
                    'start':'true',
                    'file_name':$('#filename'+id).text(),
                    'path':localStorage.getItem('current_path'),
                    'file_data':'nothing'
                },
                error: function (xhr, state, error) {
                    alert(error)
                },
                complete: function (XMLHttpRequest, status) {
                    if (status == 'timeout') {
                        request.abort();
                        window.alert('timeout')
                    }
                },
                success: function (response) {
                    if(response == "success"){
                        $('#row' + id).remove();
                        $('#my-nav').height($(document).height());
                    }
                    alert(response);
                }
            });
        }
    }

    function newfolder() {
        var folder_name = prompt('Êñ∞Âª∫Êñá‰ª∂Â§π');
        if (folder_name == null || folder_name.length == 0) {
            return;
        }
        var request = $.ajax({
                url: 'newfolder',
                type: 'POST',
                async: true,
                timeout: 10000,
                dataType:"text",
                data: { 
                    'start':'true',
                    'file_name':folder_name,
                    'path':localStorage.getItem('current_path'),
                    'file_data':'none'
                },
                error: function (xhr, state, error) {
                    alert(error)
                },
                complete: function (XMLHttpRequest, status) {
                    if (status == 'timeout') {
                        request.abort();
                        window.alert('timeout')
                    }
                },
                success: function (response) {
                    if(response == "success"){
                        var today = new Date();
                        var current_time = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate() +' '+today.getHours() + ':' + today.getMinutes() + ":" + today.getSeconds();
                        var i = new Date().getTime();
                        var data = $('#my-table-body').html();
                        var size = '';
                        data += '<tr class="tr-style" id="row' + i + '">';
                        data += '<td><a onClick="fileclick(' + i + ')" href="javascript:" id="filename'+i+'">' + folder_name + '/' + '</a></td>';
                        data += '<td>' + '--' + '</td>';
                        data += '<td>' + current_time + '</td>';
                        data += '<td><button class="button button-small button-glow button-circle button-action button-jumbo" onClick="upvote(' + i + ')">üëç</button>&nbsp<span>0</span>&nbsp'
                            + '<button class="button button-small button-glow button-circle button-royal" onClick="downvote(' + i + ')">üëé</button>&nbsp<span>0</span></td>';
                        data += '<td><button class="button button-small button-box button-jumbo" onClick="deletefile(' + i + ')">‚ùå</butotn></td>';
                        data += '</tr>';
                        $('#my-table-body').html(data);
                        $('#my-nav').height($(document).height());
                    }
                    alert(response);
                }
            });

    }


    function userLogout() {
        localStorage.setItem('username', '');
        window.location.href = 'login.html';
    }
  </script>
</body>
</html>
